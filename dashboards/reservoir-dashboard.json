{
  "name": "Trace-Aware Reservoir Sampling Dashboard",
  "description": "Monitoring dashboard for trace-aware reservoir sampler in NR-DOT",
  "pages": [
    {
      "name": "Reservoir Sampling Overview",
      "description": "Key metrics for monitoring the reservoir sampler",
      "widgets": [
        {
          "title": "Traces in Reservoir",
          "visualization": "gauge",
          "layout": {
            "row": 1,
            "column": 1,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT latest(pte_reservoir_traces_in_reservoir_count) FACET service.name, k8s.pod.name"
              }
            ],
            "thresholds": [
              {
                "value": 100,
                "color": "#F5A623"
              },
              {
                "value": 1000,
                "color": "#85CA3A"
              }
            ]
          }
        },
        {
          "title": "Reservoir Utilization",
          "visualization": "line",
          "layout": {
            "row": 1,
            "column": 7,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT latest(pte_reservoir_traces_in_reservoir_count) / 5000 * 100 as 'Utilization %' TIMESERIES FACET service.name, k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "Checkpoint Age",
          "visualization": "gauge",
          "layout": {
            "row": 4,
            "column": 1,
            "width": 4,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT latest(pte_reservoir_checkpoint_age_seconds) FACET service.name, k8s.pod.name"
              }
            ],
            "thresholds": [
              {
                "value": 10,
                "color": "#85CA3A"
              },
              {
                "value": 30,
                "color": "#F5A623"
              },
              {
                "value": 60,
                "color": "#D0021B"
              }
            ]
          }
        },
        {
          "title": "Checkpoint DB Size",
          "visualization": "line",
          "layout": {
            "row": 4,
            "column": 5,
            "width": 4,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT latest(pte_reservoir_db_size_bytes) / 1024 / 1024 as 'DB Size (MB)' TIMESERIES FACET service.name, k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "LRU Evictions",
          "visualization": "line",
          "layout": {
            "row": 4,
            "column": 9,
            "width": 4,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT rate(sum(pte_reservoir_lru_evictions_total), 1 minute) TIMESERIES FACET service.name, k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "Trace Sampling Rate",
          "visualization": "billboard",
          "layout": {
            "row": 7,
            "column": 1,
            "width": 3,
            "height": 2
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Span SELECT latest(pte_reservoir_traces_in_reservoir_count) / count(*) * 100 as 'Sampling %' WHERE sampled = true FACET service.name"
              }
            ]
          }
        },
        {
          "title": "Sampling Results",
          "visualization": "pie",
          "layout": {
            "row": 7,
            "column": 4,
            "width": 4,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Span SELECT count(*) FACET sampled, service.name SINCE 1 hour AGO"
              }
            ]
          }
        },
        {
          "title": "Checkpoint Errors",
          "visualization": "bar",
          "layout": {
            "row": 7,
            "column": 8,
            "width": 5,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT sum(pte_reservoir_checkpoint_errors_total) FACET service.name, k8s.pod.name SINCE 1 day AGO"
              }
            ]
          }
        },
        {
          "title": "Traces per Service",
          "visualization": "table",
          "layout": {
            "row": 10,
            "column": 1,
            "width": 12,
            "height": 4
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Span SELECT count(*) as 'Total Spans', uniqueCount(trace.id) as 'Unique Traces', uniqueCount(trace.id) / count(*) as 'Avg Spans per Trace' FACET service.name SINCE 1 hour AGO"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Resource Utilization",
      "description": "Resource usage for the NR-DOT collector with reservoir sampling",
      "widgets": [
        {
          "title": "CPU Usage",
          "visualization": "line",
          "layout": {
            "row": 1,
            "column": 1,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT average(cpu.utilization) TIMESERIES WHERE service.name = 'otel-collector' FACET k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "Memory Usage",
          "visualization": "line",
          "layout": {
            "row": 1,
            "column": 7,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT average(memory.used) / 1024 / 1024 as 'Memory (MB)' TIMESERIES WHERE service.name = 'otel-collector' FACET k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "Disk I/O",
          "visualization": "line",
          "layout": {
            "row": 4,
            "column": 1,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT rate(sum(disk.io.read_bytes), 1 minute) / 1024 / 1024 as 'Read MB/s', rate(sum(disk.io.write_bytes), 1 minute) / 1024 / 1024 as 'Write MB/s' TIMESERIES WHERE service.name = 'otel-collector' FACET k8s.pod.name"
              }
            ]
          }
        },
        {
          "title": "Network Traffic",
          "visualization": "line",
          "layout": {
            "row": 4,
            "column": 7,
            "width": 6,
            "height": 3
          },
          "rawConfiguration": {
            "nrqlQueries": [
              {
                "accountId": 0,
                "query": "FROM Metric SELECT rate(sum(network.io.received_bytes), 1 minute) / 1024 / 1024 as 'Received MB/s', rate(sum(network.io.transmitted_bytes), 1 minute) / 1024 / 1024 as 'Transmitted MB/s' TIMESERIES WHERE service.name = 'otel-collector' FACET k8s.pod.name"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Alerts",
      "description": "Alert conditions for reservoir sampling",
      "widgets": [
        {
          "title": "Recommended Alert: Checkpoint Age",
          "visualization": "markdown",
          "layout": {
            "row": 1,
            "column": 1,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## Checkpoint Age Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT latest(pte_reservoir_checkpoint_age_seconds) WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 2x checkpoint_interval\n\n**Priority**: Critical\n\n**Description**: Checkpoints are not being created, which could lead to data loss on restart."
          }
        },
        {
          "title": "Recommended Alert: Trace Buffer Evictions",
          "visualization": "markdown",
          "layout": {
            "row": 1,
            "column": 5,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## Trace Buffer Evictions Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT rate(sum(pte_reservoir_lru_evictions_total), 1 minute) WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 100 evictions per minute\n\n**Priority**: Warning\n\n**Description**: High rate of trace buffer evictions indicates that the buffer size may be too small for your trace volume."
          }
        },
        {
          "title": "Recommended Alert: Checkpoint Errors",
          "visualization": "markdown",
          "layout": {
            "row": 1,
            "column": 9,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## Checkpoint Errors Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT sum(pte_reservoir_checkpoint_errors_total) WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 0\n\n**Priority**: Critical\n\n**Description**: Errors during checkpoint operations could lead to data loss. Check disk space and permissions."
          }
        },
        {
          "title": "Recommended Alert: Reservoir Size Too Small",
          "visualization": "markdown",
          "layout": {
            "row": 5,
            "column": 1,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## Reservoir Size Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT latest(pte_reservoir_traces_in_reservoir_count) / 5000 * 100 WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 95%\n\n**Priority**: Warning\n\n**Description**: Reservoir is nearly full. Consider increasing the size_k setting for better sampling distribution."
          }
        },
        {
          "title": "Recommended Alert: DB Size Growing Too Fast",
          "visualization": "markdown",
          "layout": {
            "row": 5,
            "column": 5,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## DB Size Growth Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT derivative(latest(pte_reservoir_db_size_bytes), 1 hour) / 1024 / 1024 as 'Growth MB/hr' WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 100 MB/hr\n\n**Priority**: Warning\n\n**Description**: Checkpoint database is growing rapidly. Check compaction settings and ensure sufficient disk space."
          }
        },
        {
          "title": "Recommended Alert: Memory Usage High",
          "visualization": "markdown",
          "layout": {
            "row": 5,
            "column": 9,
            "width": 4,
            "height": 4
          },
          "rawConfiguration": {
            "text": "## Memory Usage Alert\n\nRecommended NRQL:\n```sql\nFROM Metric SELECT average(memory.used) / 1024 / 1024 / 1024 as 'Memory (GB)' WHERE service.name = 'otel-collector' FACET k8s.pod.name\n```\n\n**Threshold**: > 80% of container limit\n\n**Priority**: Critical\n\n**Description**: NR-DOT collector is using too much memory. Check trace buffer settings and consider scaling resources."
          }
        }
      ]
    }
  ]
}